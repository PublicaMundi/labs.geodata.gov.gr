---

 - hosts: ckan
   tasks:
   - set_fact:
       ckan_server: '{{inventory_hostname}}:80'
   - set_fact:
       ckan_url: 'http://{{inventory_hostname}}/'
       
 - hosts: proxy
   remote_user: root
  
   pre_tasks:
   - set_fact:
       ckan_hosts: '{{groups["ckan"]}}'

   - set_fact:
       haproxy:
         frontends:
           'default':
             name: 'default'
             bind:
             - { address: '{{networking.if.internal_ipv4.address}}:80' }
             vhosts: 
             - name: 'catalog'
               hostname: 
               - '{{common_name}}'
               path:
               - name: 'ckan'
                 prefix: ~
                 backend:
                   opts: { forwardfor: ~ }
                   servers: '{{hostvars| map_keys(ckan_hosts, "{0}/ckan_server", "/")| list_values}}'
             - name: 'any'
               path:
               - name: 'any'
                 prefix: ~
                 backend:
                   servers:
                   - address: '{{inventory_hostname}}:8080'

   roles:
   - www-proxy
  
   tasks:
